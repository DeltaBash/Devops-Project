version: 0.2

env:
  secrets-manager:
    LOGIN: x23195975_SecretMan:sonartoken
    HOST: x23195975_SecretMan:HOST
    Organization: x23195975_SecretMan:Organization
    Project: x23195975_SecretMan:Project

phases:
  pre_build:
    commands:
      - wget https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-5.0.1.3006-linux.zip
      - unzip sonar-scanner-cli-5.0.1.3006-linux.zip
      - export PATH=$PATH:/sonar-scanner-5.0.1.3006-linux/bin/

  build:
    commands:
      # Print environment variables for debugging
      - echo "LOGIN=$LOGIN"
      - echo "HOST=$HOST"
      - echo "Organization=$Organization"
      - echo "Project=$Project"
      
      # Verify SonarScanner installation and path
      - ls -l /sonar-scanner-5.0.1.3006-linux/bin/
      
      # Execute SonarScanner command
      - /sonar-scanner-5.0.1.3006-linux/bin/sonar-scanner \
        -Dsonar.login=$LOGIN \
        -Dsonar.host.url=$HOST \
        -Dsonar.projectKey=$Project \
        -Dsonar.organization=$Organization

      # Check the quality gate status
      - curl -u $LOGIN https://sonarcloud.io/api/qualitygates/project_status?projectKey=$Project -o result.json
      - cat result.json

      # Fail the build if the quality gate status is not "OK"
      - if [ "$(jq -r '.projectStatus.status' result.json)" != "OK" ]; then exit 1; fi
